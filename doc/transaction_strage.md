# トランザクションストレージ
更新日: 2015/07/31

## 趣旨
本事業では、トランザクションストレージの作成を求めている。
仕様はSS-MIX2 標準化ストレージ 構成の説明と構築のガイドライン Ver.1.2c P32～及び、SS-MIX2 拡張ストレージ 構成の説明と構築のガイドライン Ver.1.2c P13～に記載のある通りである。

## トランザクションストレージ 物理構造

    |-- 標準化トランザクションストレージ ルートフォルダー
        |-- トランザクション発生年フォルダー
            |-- トランザクションデータファイル(TR_YYYYMMDDHHMMSSFFF_nnnnn.DAT)

    |-- 拡張トランザクションストレージ ルートフォルダー
        |-- トランザクション発生年フォルダー
            |-- トランザクションデータファイル(TR_YYYYMMDDHHMMSSFFF_nnnnn.DAT)

トランザクションデータファイルは仕様書の通り、日付が変わった時点、もしくは記録中のファイルが一定量を超えた時点で新たなファイルを作成して記録先を切り替えること。
1年分のファイルが1フォルダに作成されることを考慮すること。

以下、標準化ストレージのトランザクションストレージを想定して記述する。拡張トランザクションストレージとして読む場合は、以下の単語を読み替えること。

* 標準化ストレージ: 拡張ストレージ
* データ種別: データ種別フォルダ
* オーダーNo: 特定キー

## 想定される挙動

### 有効データ作成時

まったくの新規作成を行いたい場合、および既存データの更新を行いたい場合、以下のように処理する。

#### トランザクションストレージ：
　処理区分『INS』でメッセージが記録される。

#### 標準化ストレージ：

1. 新規メッセージデータの患者ID、診療日、データ種別、オーダNoと一致するファイルが存在する場合、ファイル名をリネームする(コンディションフラグ『1』→『2』)
2. 新規メッセージデータの患者ID、診療日、データ種別、オーダNo、トランザクション日時、診療科コードから新規ファイル名を決定し、作成する。コンディションフラグは『1』である。

### 削除データ作成時

既存データを削除したい場合、以下のように処理をする。

#### トランザクションストレージ：
　処理区分『DEL』でメッセージが記録される。

#### 標準化ストレージ：
1. 削除メッセージデータの患者ID、診療日、データ種別、オーダNoと一致するファイルを探し、ファイル名をリネームする(コンディションフラグ『1』→『0』)
2. 削除メッセージデータの患者ID、診療日、データ種別、オーダNo、トランザクション日時、診療科コードから新規ファイル名を決定し、作成する。コンディションフラグは『0』である。

### 標準化ストレージとトランザクションストレージの数の関係

標準化ストレージのファイル数と標準化トランザクションストレージのヘッダ数は同一となる。  
コンディションフラグごとのファイル数と処理区分ごとのヘッダ数の関係は以下の通りである。

    DEL = _0 / 2  
    INS = _1 + _2 - _0 / 2
