# インデックスデータベース
更新日: 2017/03/10

## 趣旨
本事業では、インデックスデータベースの作成を求めている。
テーブルの構造およびスキーマは、SS-MIX2 標準化ストレージ 構成の説明と構築のガイドライン Ver.1.2d P35～及び、
SS-MIX2 拡張ストレージ 構成の説明と構築のガイドライン Ver.1.2d P18～に記載のある通りである。
また、同ガイドラインにある通り、必要に応じて新たな項目を追加することも可能であるが、少なくとも以下の定義に記載されたテーブル名、フィールド名、型、長さについては遵守すること。
なお、標準化ストレージと拡張ストレージの情報は１つのテーブルに記録することとする。

## 定義(ガイドラインより抜粋)

テーブル名: SSMIXIDX

|No|項目(フィールド名)|型(ODBCデータ型)|長さ|備考|
|----|----|----|----|----|
|1|ボリュームラベル（VolumeLabel）|半角英数可変文字(SQL_VARCHAR)|20|標準化ストレージ/拡張ストレージのルートディレクトリに対応した識別子|
|2|医療施設ID(FacilityID)|半角英数固定文字(SQL_CHAR)|10|標準化ストレージ/拡張ストレージの物理格納先となった各項目値または根拠値|
|3|患者ID(PatientID)|半角英数可変文字(SQL_VARCHAR)|15|〃|
|4|診療日(OrderDate)|半角英数可変文字(SQL_VARCHAR)|8|〃|
|5|データ種別/データ種別フォルダ名(DataKind)|半角英数可変文字(SQL_VARCHAR)|180|〃|
|6|オーダNo/特定キー(OrderNo)|半角英数可変文字(SQL_VARCHAR)|22|〃|
|7|処理区分(ProcessingType)|半角英数可変文字(SQL_VARCHAR)|3|〃|
|8|診療科コード(EnterOrgCD)|半角英数可変文字(SQL_VARCHAR)|5|〃|
|9|トランザクション日時(TransactionDatetime)|半角英数可変文字(SQL_VARCHAR)|17|〃|
|10|ファイル出力先ディレクトリ/コンテンツフォルダ出力先ディレクトリ(OutRelDirectory)|半角英数可変文字(SQL_VARCHAR)|260|ボリュームラベルに紐づく標準化ストレージ/拡張ストレージルートからの相対パス|
|11|ファイル名/コンテンツフォルダ名(FileName)|半角英数可変文字(SQL_VARCHAR)|260||
|12|更新日時(UpdateDatetime)|タイムスタンプ(SQL_TIMESTAMP)||当レコードを登録・更新した日時|

## ボリュームラベル
ボリュームラベルに設定する識別文字列は自由に決めてかまわない。標準化ストレージと拡張ストレージが区別できるように、例えば以下のように設定する。

* 標準化ストレージ: STDnn  
* 拡張ストレージ: ANXnn  

複数のストレージが存在する場合、nnにそれらが識別できる文字列を設定する。必要のない場合nnは省略する。


## 想定される挙動

### 有効データ作成時

1. メッセージデータの患者ID、診療日、データ種別、オーダNoと一致するレコードが存在する場合、FileNameを\*_1から\*_2に、UpdateDatetimeを更新時刻にUPDATEする。
2. メッセージデータの患者ID、診療日、データ種別/データ種別フォルダ名、オーダNo、トランザクション日時、診療科コードから新規行を作成し、INSERTする。処理区分はINSである。

### 削除データ作成時

1. メッセージデータの患者ID、診療日、データ種別、オーダNoと一致するレコードが存在する場合、FileNameを\*_1から\*_0に、UpdateDatetimeを更新時刻にUPDATEする。
2. メッセージデータの患者ID、診療日、データ種別/データ種別フォルダ名、オーダNo、トランザクション日時、診療科コードから新規行を作成し、INSERTする。処理区分はDELである。なお、拡張ストレージの情報削除時、ファイル名を\*_0にリネームするだけの場合、この処理は行わない。

## センターサーバーからの問い合わせとして想定されるSQL

後日記載

## インデックスの考え方

有効(削除)データ作成効率化のためのインデックス付与については、各社システムの挙動にあわせて検討すること。
センターサーバーからの問い合わせに一定速度で応答をするためのインデックス付与については、以下の通り。

後日記載
